<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/header-apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/header-icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/header-icon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="naExO9JokuG3a-OHUdrF8UrtMPNf1FyJ5Yt99ihFezY">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"klysisle.space","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="redis 一些常用内容">
<meta property="og:type" content="article">
<meta property="og:title" content="redis 常用">
<meta property="og:url" content="https://klysisle.space/archives/88fcd214.html">
<meta property="og:site_name" content="Klysisle&#39;s 小窝">
<meta property="og:description" content="redis 一些常用内容">
<meta property="og:locale">
<meta property="article:published_time" content="2020-10-30T12:38:51.000Z">
<meta property="article:modified_time" content="2024-12-11T08:54:40.707Z">
<meta property="article:author" content="Kinly">
<meta property="article:tag" content="常用备忘">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://klysisle.space/archives/88fcd214.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>redis 常用 | Klysisle's 小窝</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Klysisle's 小窝</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Klysisle's 小窝</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://klysisle.space/archives/88fcd214.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/kinly-avatar.png">
      <meta itemprop="name" content="Kinly">
      <meta itemprop="description" content="Klysisle's 小窝">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Klysisle's 小窝">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          redis 常用
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-30 20:38:51" itemprop="dateCreated datePublished" datetime="2020-10-30T20:38:51+08:00">2020-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-12-11 16:54:40" itemprop="dateModified" datetime="2024-12-11T16:54:40+08:00">2024-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%9F%A5%E8%AF%86%E5%A4%87%E5%BF%98/" itemprop="url" rel="index"><span itemprop="name">知识备忘</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <div class="post-description">redis 一些常用内容</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="Redis-Cluster-使用-lua-问题："><a href="#Redis-Cluster-使用-lua-问题：" class="headerlink" title="Redis Cluster 使用 lua 问题："></a>Redis Cluster 使用 lua 问题：</h2><p>EVAL 定义是： <code>EVAL script numkeys key [key…] arg [arg…]</code><br>设计者期望所有<code>操作的KEY</code> 都是用 <code>KEYS</code>传进去的，EVAL执行前会<code>检查一下所有的KEYS</code>，根据这些<code>KEYS</code>找到把指令发送到那个<code>节点</code>上<br>这里的<code>节点</code>对应 Cluster 就是 Slots，一共16384个Slots，规则是 SLOT &#x3D; CRC16(KEY) mod 16384</p>
<p>&#96;<br>16384 The reason is:<br>    1. Normal heartbeat packets carry the full configuration of a node, that can be replaced in an idempotent way with the old in order to update an old config. This means they contain the slots configuration for a node, in raw form, that uses 2k of space with16k slots, but would use a prohibitive 8k of space using 65k slots.<br>    2. At the same time it is unlikely that Redis Cluster would scale to more than 1000 mater nodes because of other design tradeoffs.<br>So 16k was in the right range to ensure enough slots per master with a max of 1000 maters, but a small enough number to propagate the slot configuration as a raw bitmap easily. Note that in small clusters the bitmap would be hard to compress because when N is small the bitmap would have slots&#x2F;N bits set that is a large percentage of bits set.</p>
<p>From <a target="_blank" rel="noopener" href="https://github.com/redis/redis/issues/2576">https://github.com/redis/redis/issues/2576</a><br>&#96;</p>
<p>根据上面的规则，传入的<code>KEYS如果不是同样的SLOT</code>，就会报错  <code>CROSSSLOT Keys in request don&#39;t hash to the same slot</code><br>如果不传 KEYS 只使用 ARGV，或者直接lua写死多个KEY的方式，比如:<br>    <code>redis.call(&#39;get&#39;, &#39;123abc&#39;);     redis.call(&#39;get&#39;, &#39;123def&#39;);   -- 这里没有做测试，认为 &#39;123abc&#39; 和 &#39;123def&#39; 是不同的SLOT</code><br>这时候会报错类似 ERR Error running script (call to f_8ead0f68893988e15c455c0b6c8ab9982e2e707c): @user_script:1: @user_script: 1: Lua script attempted to access a non local key in a cluster node<br>可以用 <code>&#123;&#125;</code> 括起来计算SLOT用的部分，保证 <code>&#123;&#125;</code> 括起来的部分是<code>相同</code>的，<br>Redis 集群的拓扑结构是是一个全连通的网络，每一个节点之间都会建立一个 Cluster Bus，所以集群的任何配置变动都会立即同步到各个节点，也就是说，每一个节点都知道哪些 Slot 对应哪个节点。<br>所以不论客户端连接到哪个节点进行执行指令，服务端都会正确的指示客户端应当重定向到哪一个节点来操作。<br>    <code>    redis.call(&#39;get&#39;, &#39;&#123;123&#125;abc&#39;);     redis.call(&#39;get&#39;, &#39;&#123;123&#125;def&#39;);  -- SLOT 计算将会用 123 计算    </code><br>但是这样 SLOT 所在节点压力就会变大，<code>不均衡</code><br>原本这两个操作会分布在两个SLOT，但是现在都用一个SLOT执行，而且这样的做法业务不友好</p>
<hr>
<h2 id="unable-to-connect-to-RedisURI-报错"><a href="#unable-to-connect-to-RedisURI-报错" class="headerlink" title="unable to connect to RedisURI 报错:"></a>unable to connect to RedisURI 报错:</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># By default protected mode is enabled. You should disable it only if</span><br><span class="line"># you are sure you want clients from other hosts to connect to Redis</span><br><span class="line"># even if no authentication is configured, nor a specific set of interfaces</span><br><span class="line"># are explicitly listed using the &quot;bind&quot; directive.</span><br><span class="line">protected-mode no</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Redis-Cluster-批量删除（shell）："><a href="#Redis-Cluster-批量删除（shell）：" class="headerlink" title="Redis Cluster 批量删除（shell）："></a>Redis Cluster 批量删除（shell）：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> != 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: ./del_redis.sh pattern&quot;</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span>;</span><br><span class="line"></span><br><span class="line">ips=(192.168.1.1 192.168.1.2)</span><br><span class="line">ports=(6379 6380 6381)</span><br><span class="line"></span><br><span class="line">redis_cluster_ip=192.168.2.1</span><br><span class="line">redis_cluster_port=6379</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> <span class="variable">$&#123;ips[@]&#125;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">for</span> port <span class="keyword">in</span> <span class="variable">$&#123;ports[@]&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ip: <span class="variable">$&#123;ip&#125;</span> port: <span class="variable">$&#123;port&#125;</span>&quot;</span></span><br><span class="line">    redis-cli -h <span class="variable">$ip</span> -p <span class="variable">$port</span> --scan --pattern <span class="string">&quot;<span class="variable">$1</span>&quot;</span> | xargs -i redis-cli -h <span class="variable">$ip</span> -p <span class="variable">$port</span> del &#123;&#125;</span><br><span class="line">  <span class="keyword">done</span>;</span><br><span class="line"><span class="keyword">done</span>;</span><br><span class="line"></span><br><span class="line">redis_nodes=`redis-cli -h <span class="variable">$redis_cluster_ip</span> -p <span class="variable">$redis_cluster_port</span> -c cluster nodes | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 2`</span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> <span class="variable">$redis_nodes</span>; <span class="keyword">do</span></span><br><span class="line">    node_redis_ip=`<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$node</span>&quot;</span> | awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">    node_redis_port=`<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$node</span>&quot;</span> | awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;------- redis-cluster <span class="variable">$&#123;node&#125;</span> <span class="variable">$&#123;node_redis_ip&#125;</span> <span class="variable">$&#123;node_redis_port&#125;</span> flushall -------&quot;</span></span><br><span class="line">    redis-cli -h <span class="variable">$node_redis_ip</span> -p <span class="variable">$node_redis_port</span> -c flushall</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="排行榜（c-lua）："><a href="#排行榜（c-lua）：" class="headerlink" title="排行榜（c++ &amp; lua）："></a>排行榜（c++ &amp; lua）：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// redis zset score between -9007199254740992 and 9007199254740992</span></span><br><span class="line"><span class="comment">// ( MAX_SCORE &amp; score ) &lt;&lt; 32 | timeseconds</span></span><br><span class="line"><span class="function"><span class="type">int64_t</span> <span class="title">calc_score</span><span class="params">(<span class="type">int64_t</span> base_value)</span> </span>&#123;</span><br><span class="line">    <span class="type">int64_t</span> time_curr = std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(std::chrono::system_clock::<span class="built_in">now</span>().<span class="built_in">time_since_epoch</span>()).<span class="built_in">count</span>();</span><br><span class="line">    <span class="keyword">return</span> ((MAX_SCORE &amp; base_value) &lt;&lt; <span class="number">32</span>) | (time_curr - SUB_TIME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--  前 count 名</span><br><span class="line"><span class="string">&quot;local count = KEYS[1];\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;local revrange = redis.pcall(&#x27;ZREVRANGE&#x27;, &#x27;&quot;</span>+ RANK_REDIS_ZSET_PVP_KEY + <span class="string">&quot;&#x27;, 0, count - 1);\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;local result = &#123;&#125;;\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;for _, v in ipairs(revrange) do\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  local ones = redis.pcall(&#x27;GET&#x27;, &#x27;&quot;</span>+ RANK_REDIS_ONES_PVP_INFO + <span class="string">&quot;&#x27;..v);\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  table.insert(result, ones);\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;end\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;return result;\n&quot;</span></span><br><span class="line"></span><br><span class="line">-- 自己的排名</span><br><span class="line"><span class="string">&quot;local user = KEYS[1];\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;local revrank = redis.pcall(&#x27;ZREVRANK&#x27;, &#x27;&quot;</span>+ RANK_REDIS_ZSET_PVP_KEY + <span class="string">&quot;&#x27;, user);\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;local result = &#123;&#125;;\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;if (revrank ~= false) then\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  local ones = redis.pcall(&#x27;GET&#x27;, &#x27;&quot;</span>+ RANK_REDIS_ONES_PVP_INFO + <span class="string">&quot;&#x27;..user);\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  table.insert(result, tostring(revrank + 1));\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  table.insert(result, ones);\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;else\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  table.insert(result, tostring(-1));\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  table.insert(result, &#x27;&#123;&#125;&#x27;);\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;end\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;return result;\n&quot;</span>;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="定时任务（lua）："><a href="#定时任务（lua）：" class="headerlink" title="定时任务（lua）："></a>定时任务（lua）：</h2><h2 id="key-任务数据，score：时间戳对于分布式系统，服务器间时间可能有些许差异，只关注超时触发的话可以使用redis拿到的时间-add-task-consume-task"><a href="#key-任务数据，score：时间戳对于分布式系统，服务器间时间可能有些许差异，只关注超时触发的话可以使用redis拿到的时间-add-task-consume-task" class="headerlink" title="key: 任务数据，score：时间戳对于分布式系统，服务器间时间可能有些许差异，只关注超时触发的话可以使用redis拿到的时间- add task:- consume task:"></a>key: 任务数据，score：时间戳<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> taskList = redis.<span class="built_in">pcall</span>(<span class="string">&#x27;ZRANGEBYSCORE&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>], ARGV[<span class="number">2</span>], <span class="string">&#x27;limit&#x27;</span>, ARGV[<span class="number">3</span>], ARGV[<span class="number">4</span>]);</span><br><span class="line"><span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">pairs</span>(taskList) <span class="keyword">do</span></span><br><span class="line">    redis.call(<span class="string">&#x27;ZADD&#x27;</span>,KEYS[<span class="number">1</span>], ARGV[<span class="number">5</span>], v)       <span class="comment">-- 更新为下一个触发时间点, 避免任务丢失</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">return</span> taskList</span><br></pre></td></tr></table></figure><br><strong>对于分布式系统，服务器间时间可能有些许差异，只关注超时触发的话可以使用redis拿到的时间</strong><br>- add task:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> timestamp = redis.call(<span class="string">&#x27;TIME&#x27;</span>);</span><br><span class="line"><span class="keyword">local</span> timeout_ms = <span class="built_in">tonumber</span>(timestamp[<span class="number">1</span>]) * <span class="number">1000</span> + <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">if</span> (ARGV[<span class="number">3</span>] == <span class="literal">nil</span>) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">return</span> redis.call(<span class="string">&#x27;ZADD&#x27;</span>, KEYS[<span class="number">1</span>], timeout_ms, ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">return</span> redis.call(<span class="string">&#x27;ZADD&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">3</span>], timeout_ms, ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><br>- consume task:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> timestamp = redis.call(<span class="string">&#x27;TIME&#x27;</span>);</span><br><span class="line"><span class="keyword">local</span> curr_ms = <span class="built_in">tonumber</span>(timestamp[<span class="number">1</span>]) * <span class="number">1000</span> + <span class="built_in">tonumber</span>(timestamp[<span class="number">2</span>]) / <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">local</span> next_ms = curr_ms + <span class="built_in">tonumber</span>(ARGV[<span class="number">5</span>]);</span><br><span class="line"><span class="keyword">local</span> taskList = redis.<span class="built_in">pcall</span>(<span class="string">&#x27;ZRANGEBYSCORE&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>], curr_ms, <span class="string">&#x27;limit&#x27;</span>, ARGV[<span class="number">3</span>], ARGV[<span class="number">4</span>]);</span><br><span class="line"><span class="keyword">for</span> k,v  <span class="keyword">in</span> <span class="built_in">pairs</span>( taskList) <span class="keyword">do</span></span><br><span class="line">  redis.call(<span class="string">&#x27;ZADD&#x27;</span>, KEYS[<span class="number">1</span>], next_ms, v)</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">return</span> taskList</span><br></pre></td></tr></table></figure></h2><h2 id="分布式锁（java）："><a href="#分布式锁（java）：" class="headerlink" title="分布式锁（java）："></a>分布式锁（java）：</h2><ul>
<li><p>基于redis单线程模型+lua原子的特性</p>
</li>
<li><p>前置条件是redis的lock和unlock是在业务的同一个线程里面的</p>
</li>
<li><p>lock 任何情况下都会释放</p>
</li>
<li><p>线程局部变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IdThreadLocalHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; idThreadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>();</span><br><span class="line"></span><br><span class="line">    IdThreadLocalHelper() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="keyword">final</span> String value)</span> &#123;</span><br><span class="line"></span><br><span class="line">        idThreadLocal.set(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> idThreadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>加锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(String key, <span class="type">long</span> expireSecs)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> IdUtils.getUUid();</span><br><span class="line">    IdThreadLocalHelper.put(uuid);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> redisStandalone.set(key, uuid, <span class="string">&quot;NX&quot;</span>, <span class="string">&quot;EX&quot;</span>, expireSecs);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span>.equalsIgnoreCase(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>解锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">unLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">requestId</span> <span class="operator">=</span> IdThreadLocalHelper.get();</span><br><span class="line">    <span class="keyword">if</span>(requestId == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; listKeys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    listKeys.add(key);</span><br><span class="line">    String[] keys = listKeys.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> redisStandalone.eval(script, ScriptOutputType.INTEGER, keys, requestId);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> == result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>应用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="variable">locked</span> <span class="operator">=</span> lock(lockKey, <span class="number">15</span>);</span><br><span class="line"><span class="keyword">if</span> (!locked) &#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> lock error</span></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> logic</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lobbyServiceRedis.lobbyUnlock(lockKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="重度redis-lua使用的一些基础功能（lua）"><a href="#重度redis-lua使用的一些基础功能（lua）" class="headerlink" title="重度redis lua使用的一些基础功能（lua）:"></a>重度redis lua使用的一些基础功能（lua）:</h2><ul>
<li>local 前置声明定义<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> KEY_XXX = <span class="string">&#x27;test.lua.KEY_XXX&#x27;</span>;</span><br><span class="line"><span class="keyword">local</span> KEY_YYY = <span class="string">&#x27;test.lua.KEY_YYY&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>final atomic 用于lua return 前更新版本号一类的东西<ul>
<li>any : 具体要返回的内容</li>
<li>inc : 是否操作版本号变更（+1）</li>
</ul>
</li>
<li><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> atomicInc = ARGV;</span><br><span class="line"><span class="keyword">local</span> lua_oper = &#123;&#125;</span><br><span class="line">lua_oper.final = <span class="function"><span class="keyword">function</span><span class="params">(any, inc)</span></span></span><br><span class="line">  <span class="keyword">if</span> inc == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> #atomicInc == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">      redis.call(<span class="string">&#x27;INCR&#x27;</span>, KEY_ATOMIC_INC..atomicInc[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">return</span> any;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></li>
<li>redis operator 一些常用的操作封装<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">----------------------------------------------</span></span><br><span class="line"><span class="comment">-- redis operator</span></span><br><span class="line"><span class="keyword">local</span> redis_oper = &#123;&#125;</span><br><span class="line">redis_oper.zset_element = <span class="function"><span class="keyword">function</span><span class="params">(key, st, ed)</span></span></span><br><span class="line">  <span class="keyword">local</span> elescores = redis.call(<span class="string">&#x27;ZRANGE&#x27;</span>, key, st, ed, <span class="string">&#x27;WITHSCORES&#x27;</span>);</span><br><span class="line">  <span class="keyword">local</span> ele = &#123;&#125;;</span><br><span class="line">  <span class="keyword">local</span> eleKey; <span class="keyword">local</span> eleScore = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> index, val <span class="keyword">in</span> <span class="built_in">pairs</span>(elescores) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> index % <span class="number">2</span> == <span class="number">1</span> <span class="keyword">then</span> eleKey = val;</span><br><span class="line">    <span class="keyword">else</span> eleScore = <span class="built_in">tonumber</span>(val);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    ele[eleKey] = eleScore;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">return</span> ele;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">redis_oper.zset_insert = <span class="function"><span class="keyword">function</span><span class="params">(key, ele, score)</span></span></span><br><span class="line">  <span class="keyword">return</span> redis.call(<span class="string">&#x27;ZADD&#x27;</span>, key, score, ele);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">redis_oper.zset_rem = <span class="function"><span class="keyword">function</span><span class="params">(key, ele)</span></span></span><br><span class="line">  <span class="keyword">return</span> redis.call(<span class="string">&#x27;ZREM&#x27;</span>, key, ele);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">redis_oper.zset_card = <span class="function"><span class="keyword">function</span><span class="params">(key)</span></span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;ZCARD&#x27;</span>, key));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">redis_oper.set = <span class="function"><span class="keyword">function</span><span class="params">(key, key_plus, data)</span></span></span><br><span class="line">  <span class="keyword">return</span> redis.call(<span class="string">&#x27;SET&#x27;</span>, key..key_plus, data);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">redis_oper.get = <span class="function"><span class="keyword">function</span><span class="params">(key, key_plus)</span></span></span><br><span class="line">  <span class="keyword">local</span> res = redis.call(<span class="string">&#x27;GET&#x27;</span>, key..key_plus);</span><br><span class="line">  <span class="keyword">if</span> (res == <span class="literal">nil</span> <span class="keyword">or</span> (<span class="built_in">type</span>(res) == <span class="string">&#x27;boolean&#x27;</span> <span class="keyword">and</span> <span class="keyword">not</span> res)) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">redis_oper.del = <span class="function"><span class="keyword">function</span><span class="params">(key, key_plus)</span></span></span><br><span class="line">  <span class="keyword">return</span> redis.call(<span class="string">&#x27;DEL&#x27;</span>, key..key_plus);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">redis_oper.exist = <span class="function"><span class="keyword">function</span><span class="params">(key, key_plus)</span></span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;EXISTS&#x27;</span>, key..key_plus));</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></li>
<li>lua algorithm 取集合常用的函数<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------</span><br><span class="line">-- lua algorithm</span><br><span class="line">local lua_res = &#123;&#125;</span><br><span class="line">-- 数组转化成键值对table</span><br><span class="line">lua_res.<span class="keyword">new</span> = <span class="built_in">function</span>(list)</span><br><span class="line">  local tab = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> _, v in <span class="built_in">pairs</span>(list) <span class="keyword">do</span></span><br><span class="line">    tab[v] = <span class="literal">true</span></span><br><span class="line">  end</span><br><span class="line">  <span class="keyword">return</span> tab</span><br><span class="line">end</span><br><span class="line">-- 并集 a,b为键值对形式的table</span><br><span class="line">res.<span class="keyword">union</span> = <span class="built_in">function</span>(a, b)</span><br><span class="line">    local tab = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> k, _ in <span class="built_in">pairs</span>(a) <span class="keyword">do</span> tab[k] = <span class="literal">true</span> end</span><br><span class="line">    <span class="keyword">for</span> k, _ in <span class="built_in">pairs</span>(b) <span class="keyword">do</span> tab[k] = <span class="literal">true</span> end</span><br><span class="line">    <span class="keyword">return</span> res.<span class="built_in">changeToArr</span>(tab)</span><br><span class="line">end</span><br><span class="line">-- 交集 a,b为键值对形式的table</span><br><span class="line">lua_res.intersecion = <span class="built_in">function</span>(a, b)</span><br><span class="line">  local tab = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> k, v in <span class="built_in">pairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    tab[k] = b[k]</span><br><span class="line">  end</span><br><span class="line">  <span class="keyword">return</span> lua_res.<span class="built_in">change2arr</span>(tab)</span><br><span class="line">end</span><br><span class="line">-- 键值对转换成数组</span><br><span class="line">lua_res.change2arr = <span class="built_in">function</span>(tab)</span><br><span class="line">  local list = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> k, _ in <span class="built_in">pairs</span>(tab) <span class="keyword">do</span></span><br><span class="line">    list[<span class="meta">#list + 1] = k</span></span><br><span class="line">  end</span><br><span class="line">  <span class="keyword">return</span> list</span><br><span class="line">end</span><br></pre></td></tr></table></figure></li>
<li>基于上面一系列的基础内容，剩下的就是写逻辑处理代码了，这样子的逻辑代码看起来更整齐也更干净</li>
</ul>
<h2 id="备忘：一些-redis-lua-需要注意的地方"><a href="#备忘：一些-redis-lua-需要注意的地方" class="headerlink" title="备忘：一些 redis lua 需要注意的地方"></a>备忘：一些 redis lua 需要注意的地方</h2><ul>
<li>number 数值范围： range: [-(2<strong>53)+1, (2</strong>53)-1] (<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7159#section-6">https://datatracker.ietf.org/doc/html/rfc7159#section-6</a>)</li>
<li>lua cjson 精度：10进制数字14字符，超过14 encode会以科学计数法表示，以至于丢失精度，这也是lua number2string 的问题。 (<a target="_blank" rel="noopener" href="https://github.com/mpx/lua-cjson/issues/37">https://github.com/mpx/lua-cjson/issues/37</a>)</li>
</ul>
<h3 id="redis-内存置换策略"><a href="#redis-内存置换策略" class="headerlink" title="redis 内存置换策略"></a>redis 内存置换策略</h3><ul>
<li>noeviction<br><code>内存不足时直接报错 OOM command not allowed when used memory &gt; maxmemory</code>；不会清理数据</li>
<li>volatile-ttl<br><code>清理数据根据 ttl 时间（expire设置了生存时间的）从小到大依次清楚，不会清理 persist 的 key（没有过期时间的）；直到所有 expire 的 key 都清除了，报错 OOM</code></li>
<li>volatile-lru (默认)<br><code>清理数据根据 expire key 按 lru 算法（最近最少使用）采样清除；直到所有 expire 的 key 都清除了，报错 OOM</code></li>
<li>volatile-random<br><code>清理数据根据 expire key 随机清除；直到所有 expire 的 key 都清除了，报错 OOM</code></li>
<li>allkeys-lru<br><code>和 volatile-lru 的区别是不判断是否是 expire key；删除一个插入一个，不再报 OOM</code></li>
<li>allkeys-random<br><code>和 volatile-random 的区别是不判断是否是 expire key；删除一个插入一个，不再报 OOM</code></li>
</ul>
<h3 id="redis-监控项"><a href="#redis-监控项" class="headerlink" title="redis 监控项"></a>redis 监控项</h3><ul>
<li>aof_enabled, AOF是否处于打开状态</li>
<li>aof_last_write_status, 记录最近一次AOF写的结果是成功还是失败</li>
<li>blocked_clients, 正在等待阻塞命令（keys*, monitor, blpop, brpop, brpoplpush）的客户端数量</li>
<li>client_biggest_input_buf, 当前连接的客户端当中，最大输入缓存</li>
<li>client_longest_output_list, 当前连接的客户端当中，最长的输出列表</li>
<li>cluster_enabled, 集群功能是否已经开启</li>
<li>connected_clients, 已连接客户端的数量（不包括通过slave服务器连接的客户端）</li>
<li>connected_slaves, 已连接的slave服务器数量</li>
<li>evicted_keys, 因最大内存容量限制而被LRU算法置换出内存的键数量</li>
<li>expired_keys, 因过期而被自动删除的键数量</li>
<li>keyspace_hits, 查找键hit次数</li>
<li>keyspace_misses, 查找键miss次数</li>
<li>lru_clock, 以分钟为单位进行自增的时钟，用于LRU管理</li>
<li>master_link_status, slave节点复制连接当前的状态，up表示连接正常，down表示连接断开。</li>
<li>maxmemory, redis最大可用内存</li>
<li>maxmemory_policy, 内存不足时，数据清除策略，默认为volatile-lru。<ul>
<li><ol>
<li>volatile-lru：从已设置过期时间的数据集（server.db[i].expires）使用LRU算法淘汰。</li>
</ol>
</li>
<li><ol start="2">
<li>volatile-ttl：从已设置过期时间的数据集（server.db[i].expires）采取TTL算法(最小存活时间)，移除即将过期的数据。</li>
</ol>
</li>
<li><ol start="3">
<li>volatile-random：从已设置过期时间的数据集（server.db[i].expires）采取随机选取算法，并移除选中的K-V，直到”内存足够”为止，如果如果”过期集合”中全部移除全部移除仍不能满足，将OOM</li>
</ol>
</li>
<li><ol start="4">
<li>allkeys-lru：对所有数据（server.db[i].dict），采用LRU算法淘汰。</li>
</ol>
</li>
<li><ol start="5">
<li>allkeys-random：对所有的数据（server.db[i].dict）,采取”随机选取”算法,并移除选中的K-V,直到”内存足够”为止</li>
</ol>
</li>
<li><ol start="6">
<li>noeviction：禁止驱逐数据，直接返回OOM异常</li>
</ol>
</li>
</ul>
</li>
<li>mem_fragmentation_ratio, 碎片率，计算公式used_memory_rss&#x2F;used_memory</li>
<li>pubsub_channels, 当前被订阅的频道数量</li>
<li>pubsub_patterns, 当前被订阅的模式数量</li>
<li>rdb_last_bgsave_status, 最近一次创建RDB文件的结果是成功还是失败</li>
<li>role, 本机在主从架构中的角色,master和slave两种选择</li>
<li>total_commands_processed, 当前已执行的命令数量</li>
<li>total_connections_received, 当前已接受的连接请求数量</li>
<li>uptime_in_seconds, Redis服务器启动以来经过的秒数</li>
<li>used_cpu_sys, Redis服务器耗费的系统CPU</li>
<li>used_cpu_user, Redis服务器耗费的用户CPU</li>
<li>used_memory, 由Redis分配器分配的内存总量</li>
<li>used_memory_rss, 从操作系统的角度，返回Redis已分配的内存总量</li>
<li>instantaneous_ops_per_sec, 当前每秒钟执行的命令数量</li>
</ul>
<h3 id="redis-内存相关"><a href="#redis-内存相关" class="headerlink" title="redis 内存相关"></a>redis 内存相关</h3><ul>
<li><p>redis内存相关的</p>
<ul>
<li>rdb持久化</li>
<li>AOF重写</li>
<li>内存剔除策略(高版本redis还存在着内存碎片整理的配置选项),</li>
<li>其中AOF重写和rdb持久化都属于fork子进程来完成的。本次就以rdb持久化为例，rdb的持久化可以由持久化的配置策略或者命令行bgsave或者主从全同步触发。 redis在做bgsave的时候，fork出子进程来做bgsave。具体的过程如下:</li>
<li>rdbSaveBackground()中fork子进程 —&gt; rdbSave() —&gt; rdbSaveRio()。</li>
<li>fork后子进程拥有和父进程一模一样的进程空间，虽然采用了COW机制(父子进程的虚拟内存指向相同的物理page)，但是ps或者top命令中的RSS显示的值都会算成自己进程所占的物理内存，这个可能是很多运维同学&#x2F;DBA同学经常可以眼见的现象，恐怕这个就是潜意识里需要内存预留一半的重要因素。</li>
</ul>
</li>
<li><p>Linux下的进程下的地址都是虚拟地址，CPU使用的也是虚拟地址，Linux将每个进程的地址空间人为地分为用户地址空间和内核地址空间</p>
<ul>
<li>32位下  0-3G为用户地址空间，3-4G为内核地址空间(每个进程都是这样),</li>
<li>64位下，0-128T 为用户地址空间，高位-128T为内核地址空间。</li>
<li>进程中的虚拟地址和内存物理地址存在映射关系，这个映射关系由进程的页表pte来维护。</li>
<li>虚拟地址和物理地址是多对1或者1对1的关系。Linux默认情况下fork子进程会采用写时复制(Copy On Write)。</li>
<li>为了解决默认glibc内存分配器的性能和碎片率问题,redis引入了jemalloc,并成为默认配置。</li>
</ul>
</li>
<li><p>Linux的fork COW机制</p>
<ul>
<li>在内核层面看，fork 创建一个进程的动作:<ul>
<li>do_fork()</li>
<li>copy_process()</li>
<li>copy_mm()</li>
<li>dup_mm()</li>
<li>dump_nmap()</li>
<li>copy_page_range()</li>
<li>copyp4d_range()</li>
<li>copy_pmd_range()</li>
<li>copy_pte_range()</li>
<li>copy_one_pte()</li>
<li>ptep_set_wrprotect()</li>
</ul>
</li>
<li>大体上的功能就是:<br>复制当前进程的结构，复制当前进程路径，文件句柄，信号，namespace, 虚拟内存(当然包含页目录和页表)，内核栈, CPU体系结构相关信息, 在复制页表的过程中，内核会将物理page权限为设置为只读，一旦父进程</li>
<li>修改物理page的时候，会触发page fault, 内核在异常处理过程中通过pgd_alloc重新分配物理page,将先前物理page中的数据复制到新分配的物理page,同时修改父进程中页表和物理page的映射关系。(参见ULK 2.4和3.3)</li>
</ul>
</li>
<li><p>从理论上看，redis 在fork bgsave的时候，是不会让内存翻倍的， 那么是不是只要父进程的内存管够，就可以安全地进行bgsave呢？</p>
<ul>
<li><ol>
<li>在bgsave期间，业务产生的’update’类数据量(新增&#x2F;修改)。</li>
</ol>
</li>
<li><ol start="2">
<li>redis运行过程中rehash产生的内存消耗。</li>
</ol>
</li>
</ul>
</li>
</ul>

    </div>
    
    
    
    <div>
      
      <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">------ 本文结束 ------</div>
        <div style="text-align:center;color: #ccc;font-size:14px;">------ 版权声明：转载请注明出处 ------</div>
    
</div>
      
    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="https://github.com/kinly">
            <span class="icon">
              <i class="fab fa-github"></i>
            </span>

            <span class="label">GitHub</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="mailto:klysisle@outlook.com">
            <span class="icon">
              <i class="fa fa-envelope"></i>
            </span>

            <span class="label">E-Mail</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/images/kinly-wechat-channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat Image</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%B8%B8%E7%94%A8%E5%A4%87%E5%BF%98/" rel="tag"># 常用备忘</a>
              <a href="/tags/redis/" rel="tag"># redis</a>
          </div>

        
  <div class="post-widgets">
    <div class="wp_rating">
      <div id="wpac-rating"></div>
    </div>
  </div>


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/archives/537e6650.html" rel="prev" title="gdb 的常用">
      <i class="fa fa-chevron-left"></i> gdb 的常用
    </a></div>
      <div class="post-nav-item">
    <a href="/archives/559da5ab.html" rel="next" title="linux 调试相关">
      linux 调试相关 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Cluster-%E4%BD%BF%E7%94%A8-lua-%E9%97%AE%E9%A2%98%EF%BC%9A"><span class="nav-number">1.</span> <span class="nav-text">Redis Cluster 使用 lua 问题：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unable-to-connect-to-RedisURI-%E6%8A%A5%E9%94%99"><span class="nav-number">2.</span> <span class="nav-text">unable to connect to RedisURI 报错:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Cluster-%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%EF%BC%88shell%EF%BC%89%EF%BC%9A"><span class="nav-number">3.</span> <span class="nav-text">Redis Cluster 批量删除（shell）：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%92%E8%A1%8C%E6%A6%9C%EF%BC%88c-lua%EF%BC%89%EF%BC%9A"><span class="nav-number">4.</span> <span class="nav-text">排行榜（c++ &amp; lua）：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%EF%BC%88lua%EF%BC%89%EF%BC%9A"><span class="nav-number">5.</span> <span class="nav-text">定时任务（lua）：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#key-%E4%BB%BB%E5%8A%A1%E6%95%B0%E6%8D%AE%EF%BC%8Cscore%EF%BC%9A%E6%97%B6%E9%97%B4%E6%88%B3%E5%AF%B9%E4%BA%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%97%B4%E6%97%B6%E9%97%B4%E5%8F%AF%E8%83%BD%E6%9C%89%E4%BA%9B%E8%AE%B8%E5%B7%AE%E5%BC%82%EF%BC%8C%E5%8F%AA%E5%85%B3%E6%B3%A8%E8%B6%85%E6%97%B6%E8%A7%A6%E5%8F%91%E7%9A%84%E8%AF%9D%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8redis%E6%8B%BF%E5%88%B0%E7%9A%84%E6%97%B6%E9%97%B4-add-task-consume-task"><span class="nav-number">6.</span> <span class="nav-text">key: 任务数据，score：时间戳12345local taskList &#x3D; redis.pcall(&#39;ZRANGEBYSCORE&#39;, KEYS[1], ARGV[1], ARGV[2], &#39;limit&#39;, ARGV[3], ARGV[4]);for _, v in pairs(taskList) do    redis.call(&#39;ZADD&#39;,KEYS[1], ARGV[5], v)       -- 更新为下一个触发时间点, 避免任务丢失end;return taskList对于分布式系统，服务器间时间可能有些许差异，只关注超时触发的话可以使用redis拿到的时间- add task:1234567local timestamp &#x3D; redis.call(&#39;TIME&#39;);local timeout_ms &#x3D; tonumber(timestamp[1]) * 1000 + tonumber(ARGV[2]);if (ARGV[3] &#x3D;&#x3D; nil) then  return redis.call(&#39;ZADD&#39;, KEYS[1], timeout_ms, ARGV[1])else  return redis.call(&#39;ZADD&#39;, KEYS[1], ARGV[3], timeout_ms, ARGV[1])end- consume task:12345678local timestamp &#x3D; redis.call(&#39;TIME&#39;);local curr_ms &#x3D; tonumber(timestamp[1]) * 1000 + tonumber(timestamp[2]) &#x2F; 1000;local next_ms &#x3D; curr_ms + tonumber(ARGV[5]);local taskList &#x3D; redis.pcall(&#39;ZRANGEBYSCORE&#39;, KEYS[1], ARGV[1], curr_ms, &#39;limit&#39;, ARGV[3], ARGV[4]);for k,v  in pairs( taskList) do  redis.call(&#39;ZADD&#39;, KEYS[1], next_ms, v)end;return taskList</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%EF%BC%88java%EF%BC%89%EF%BC%9A"><span class="nav-number">7.</span> <span class="nav-text">分布式锁（java）：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%BA%A6redis-lua%E4%BD%BF%E7%94%A8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD%EF%BC%88lua%EF%BC%89"><span class="nav-number">8.</span> <span class="nav-text">重度redis lua使用的一些基础功能（lua）:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%87%E5%BF%98%EF%BC%9A%E4%B8%80%E4%BA%9B-redis-lua-%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9"><span class="nav-number">9.</span> <span class="nav-text">备忘：一些 redis lua 需要注意的地方</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#redis-%E5%86%85%E5%AD%98%E7%BD%AE%E6%8D%A2%E7%AD%96%E7%95%A5"><span class="nav-number">9.1.</span> <span class="nav-text">redis 内存置换策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redis-%E7%9B%91%E6%8E%A7%E9%A1%B9"><span class="nav-number">9.2.</span> <span class="nav-text">redis 监控项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redis-%E5%86%85%E5%AD%98%E7%9B%B8%E5%85%B3"><span class="nav-number">9.3.</span> <span class="nav-text">redis 内存相关</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Kinly"
      src="/uploads/kinly-avatar.png">
  <p class="site-author-name" itemprop="name">Kinly</p>
  <div class="site-description" itemprop="description">Klysisle's 小窝</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/kinly" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kinly" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:klysisle@outlook.com" title="E-Mail → mailto:klysisle@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/kinly-wechat-channel.jpg" title="WeChat Image → &#x2F;images&#x2F;kinly-wechat-channel.jpg"><i class="fab fa-weixin fa-fw"></i>WeChat Image</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      friendly
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.ai233.top/" title="https:&#x2F;&#x2F;www.ai233.top&#x2F;" rel="noopener" target="_blank">33's blog(设计师、AI)</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://gqw.github.io/" title="https:&#x2F;&#x2F;gqw.github.io&#x2F;" rel="noopener" target="_blank">顾起威's blog(后端)</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kinly</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>



  <script>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id    : ,
      el    : 'wpac-rating',
      color : 'fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>












  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '6741134bc57bd79787a9',
      clientSecret: 'ce6491d7fecebe5bf246e104cbae0f3412cc9c92',
      repo        : 'kinly.github.io',
      owner       : 'kinly',
      admin       : ['kinly'],
      id          : '91d9eb927b3dc891a70d3ece39a2ee55',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
