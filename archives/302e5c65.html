<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/header-apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/header-icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/header-icon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="naExO9JokuG3a-OHUdrF8UrtMPNf1FyJ5Yt99ihFezY">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"klysisle.space","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="一些问题 &amp; 处理">
<meta property="og:type" content="article">
<meta property="og:title" content="一些问题 &amp; 处理">
<meta property="og:url" content="https://klysisle.space/archives/302e5c65.html">
<meta property="og:site_name" content="Klysisle&#39;s 小窝">
<meta property="og:description" content="一些问题 &amp; 处理">
<meta property="og:locale">
<meta property="og:image" content="https://klysisle.space/images/BBR/cubic.png">
<meta property="og:image" content="https://klysisle.space/images/BBR/bbr.png">
<meta property="og:image" content="https://klysisle.space/images/BBR/no-tc.png">
<meta property="og:image" content="https://klysisle.space/images/BBR/public-network.png">
<meta property="article:published_time" content="2022-05-23T06:36:37.000Z">
<meta property="article:modified_time" content="2024-12-11T08:54:40.710Z">
<meta property="article:author" content="Kinly">
<meta property="article:tag" content="备忘">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://klysisle.space/images/BBR/cubic.png">

<link rel="canonical" href="https://klysisle.space/archives/302e5c65.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>一些问题 & 处理 | Klysisle's 小窝</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Klysisle's 小窝</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Klysisle's 小窝</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://klysisle.space/archives/302e5c65.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/kinly-avatar.png">
      <meta itemprop="name" content="Kinly">
      <meta itemprop="description" content="Klysisle's 小窝">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Klysisle's 小窝">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          一些问题 & 处理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-23 14:36:37" itemprop="dateCreated datePublished" datetime="2022-05-23T14:36:37+08:00">2022-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-12-11 16:54:40" itemprop="dateModified" datetime="2024-12-11T16:54:40+08:00">2024-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%9F%A5%E8%AF%86%E7%A7%AF%E7%B4%AF/" itemprop="url" rel="index"><span itemprop="name">知识积累</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <div class="post-description">一些问题 & 处理</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><ul>
<li>工作过程中对于一些问题的处理方案记录，也包含一些常用轻巧的伪代码</li>
</ul>
<h3 id="JAVA，C"><a href="#JAVA，C" class="headerlink" title="JAVA，C++"></a>JAVA，C++</h3><ul>
<li><code>近几年工作，主语言从C++切换到了Java，当时最主要的原因是Java更适合快速开发(有较完备的轮子)，Java是门有GC的语言，内存有较严格的管理，不会像C++一样容易出现内存问题；近些年流行的GO也是如此</code></li>
<li><code>Q：</code> 两者区别</li>
<li><code>R：</code> 最大的区别是在GC上。C++对于内存的使用，或者说所有权不明确，没有严格的限制（管理），这点上C++是一个开放的态度；带GC的语言对内存的管理更为严格，开发者更关注业务和框架本身。</li>
</ul>
<h3 id="CDN-强制回源"><a href="#CDN-强制回源" class="headerlink" title="CDN 强制回源"></a>CDN 强制回源</h3><ul>
<li><code>访问：</code> cdn_domain&#x2F;file?x&#x3D;123 （一个随机数）</li>
<li><code>确认：</code> postman 这样的工具可以看下回执的header里面是否有类似 X-Cache 的值包含类似 Miss 信息</li>
</ul>
<h3 id="tc-命令"><a href="#tc-命令" class="headerlink" title="tc 命令"></a>tc 命令</h3><ul>
<li>tc qdisc add dev eth0 root netem delay 100ms</li>
<li><code>这个是对网卡eth0 添加策略， 发送的数据包 延时100ms</code></li>
<li>tc qdisc add dev ens160 root netem delay 120ms 10ms</li>
<li><code>该命令将 eth0 网卡的传输设置为延迟 120ms ± 10ms (90 ~ 130 ms 之间的任意值)发送。</code></li>
<li>tc qdisc add dev eth0 root netem loss 20% 40%</li>
<li><code>该命令将 eth0 网卡的传输设置为随机丢掉 20% 的数据包,成功率为 40% </code></li>
<li>tc qdisc del dev ens160 root netem</li>
<li><code>重启网卡或者命令删除</code></li>
</ul>
<h3 id="日志解析"><a href="#日志解析" class="headerlink" title="日志解析"></a>日志解析</h3><ul>
<li><code>先截取第92-最后的字符，再以 &#125; 分割截取倒数第二个 &#125; 之前的所有内容，再补一个 &#125;，再替换 \&quot; 为 &quot;</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&#x27;BI&#x27;</span> logs/aaa.log | <span class="built_in">cut</span> -b 92- | rev | <span class="built_in">cut</span> -d <span class="string">&#x27;&#125;&#x27;</span> -f 3- | rev | sed <span class="string">&#x27;s/$/&#125;/g&#x27;</span> | sed <span class="string">&#x27;s/\\&quot;/&quot;/g&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>grep 结果逐行解析，取出eventTime时间戳转时间字符串，再组织输出</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&#x27;BI&#x27;</span> aaa.log  | <span class="built_in">cut</span> -b 92- | rev | <span class="built_in">cut</span> -d <span class="string">&#x27;&#125;&#x27;</span> -f 3- | rev | sed <span class="string">&#x27;s/$/&#125;/g&#x27;</span> | sed <span class="string">&#x27;s/\\&quot;/&quot;/g&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> line ; <span class="keyword">do</span> etime=$(<span class="built_in">echo</span> <span class="variable">$line</span> | jq <span class="string">&#x27;.eventTime&#x27;</span> | <span class="built_in">cut</span> -b -10) ; xtime=$(<span class="built_in">date</span> -d @<span class="variable">$etime</span> <span class="string">&#x27;+%F %T&#x27;</span>); <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$xtime</span>  -&gt; <span class="variable">$line</span>&quot;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>日志IP分析：</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## disconnect 的uuid存到u.txt</span></span><br><span class="line">grep <span class="string">&quot;disconnect,&quot;</span> aaa.log  | grep <span class="string">&#x27;2020-10-13 18:00&#x27;</span> | awk -F <span class="string">&#x27; &#x27;</span> <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>   &gt; u.txt</span><br><span class="line"><span class="comment">## 查u.txt里用户登录的IP</span></span><br><span class="line"><span class="built_in">cat</span> u.txt |<span class="keyword">while</span> <span class="built_in">read</span> <span class="built_in">id</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$id</span>;grep <span class="variable">$id</span>  aaa*.<span class="built_in">log</span> |grep <span class="string">&#x27;login success&#x27;</span>; <span class="built_in">echo</span> ; <span class="keyword">done</span>|<span class="built_in">tee</span> /tmp/k.log</span><br><span class="line"><span class="comment">## 用户登录的IP查运营商信息</span></span><br><span class="line"><span class="built_in">cat</span> /tmp/k.log grep city|awk -F: <span class="string">&#x27;&#123;print $24&#125;&#x27;</span>|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>|grep ^[0-9]|<span class="built_in">sort</span>|<span class="built_in">uniq</span> |<span class="keyword">while</span> <span class="built_in">read</span> ip; <span class="keyword">do</span>  res=` curl <span class="string">&quot;https://www.sudops.com/ipq/?format=json&amp;token=9a3061dc225dedc7d87e9ca02997b8de&amp;ip=<span class="variable">$ip</span>&quot;</span> 2&gt;/dev/null|grep -P -o <span class="string">&#x27;desc1&quot;:.*&#x27;</span>`; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$ip</span> <span class="variable">$res</span>&quot;</span>; <span class="built_in">sleep</span> 1; <span class="built_in">echo</span>; <span class="keyword">done</span>|<span class="built_in">tee</span> /tmp/queryip_isp.txt</span><br></pre></td></tr></table></figure>

<ul>
<li>IP解析参考： <a target="_blank" rel="noopener" href="https://www.sudops.com/interface-ip-query-json-format.html">https://www.sudops.com/interface-ip-query-json-format.html</a></li>
</ul>
<h3 id="缺省情况下，各协议的老化时间为："><a href="#缺省情况下，各协议的老化时间为：" class="headerlink" title="缺省情况下，各协议的老化时间为："></a>缺省情况下，各协议的老化时间为：</h3><table>
<thead>
<tr>
<th align="left">协议</th>
<th align="right">时间</th>
</tr>
</thead>
<tbody><tr>
<td align="left">DNS</td>
<td align="right">120 s</td>
</tr>
<tr>
<td align="left">ftp</td>
<td align="right">120 s</td>
</tr>
<tr>
<td align="left">ftp-data</td>
<td align="right">120 s</td>
</tr>
<tr>
<td align="left">HTTP</td>
<td align="right">120 s</td>
</tr>
<tr>
<td align="left">icmp</td>
<td align="right">20 s</td>
</tr>
<tr>
<td align="left">tcp</td>
<td align="right">600 s</td>
</tr>
<tr>
<td align="left">tcp-proxy</td>
<td align="right">10 s</td>
</tr>
<tr>
<td align="left">udp</td>
<td align="right">120 s</td>
</tr>
<tr>
<td align="left">sip</td>
<td align="right">1 800 s</td>
</tr>
<tr>
<td align="left">sip-media</td>
<td align="right">120 s</td>
</tr>
<tr>
<td align="left">rtsp</td>
<td align="right">60 s</td>
</tr>
<tr>
<td align="left">rtsp-media</td>
<td align="right">120 s</td>
</tr>
</tbody></table>
<ul>
<li><code>可用undo firewall-natsession &#123; all | dns | ftp | ftp-data | http | icmp | tcp | tcp-proxy | udp | sip | sip-media | rtsp |rtsp-media &#125; aging-time 命令恢复对应会话表项的超时时间为缺省值。</code></li>
</ul>
<h3 id="BBR-CUBIC-算法测试"><a href="#BBR-CUBIC-算法测试" class="headerlink" title="BBR&#x2F;CUBIC 算法测试"></a>BBR&#x2F;CUBIC 算法测试</h3><ul>
<li>cubic TC 内网测试<br><img src="/images/BBR/cubic.png"></li>
<li>bbr TC 内网测试<br><img src="/images/BBR/bbr.png"></li>
<li>去掉TC<br><img src="/images/BBR/no-tc.png"></li>
<li><code>tc只设置delay的时候两者差不多，但是一旦有了lose，差别就很大了</code></li>
<li>公网：香港-&gt;杭州（杭州机器带宽小）<br><img src="/images/BBR/public-network.png"></li>
</ul>
<h3 id="唯一ID"><a href="#唯一ID" class="headerlink" title="唯一ID"></a>唯一ID</h3><ul>
<li><p><code>老生常谈的问题，但是这个问题在期望动态扩容架构上，使用传统的**雪花算法**不是特别方便，因为随时可能会加机器，但是加机器的时候就需要考虑给这个机器单独编码才行，面对这个问题反倒是老套的**依赖数据库跳级**的方式更简单了</code></p>
</li>
<li><p><code>Q：</code> 雪花，redis自增 优缺点</p>
</li>
<li><p><code>R：</code></p>
<ul>
<li><code>雪花优点：</code> 不依赖数据库，可以根据自增位确定单位时间（一般是ms）最多的ID数量，也比较好确定算法可用的时长，一版是在80年+，对于大部分互联网业务，这都够用了</li>
<li><code>雪花缺点：</code> 强依赖时间，有回调问题需要处理；对于相同的服务，需要预先分配服务的占位Index，这个Index是有长度限制的；这方面对运维侧不友好（因为一般会把这个值放在启动项，会导致服务启动参数不同；当然也可以从数据库自己获取，先取到先占用，但是这样就又依赖了数据库）</li>
<li><code>自增优点：</code> 简单，除此之外好像其他都不明显</li>
<li><code>自增缺点：</code> 强依赖数据库（+redis），产出的ID需要混淆</li>
</ul>
</li>
<li><p><code>Q：</code> 雪花的回调处理</p>
</li>
<li><p><code>R: </code> 一般的处理办法是缓存上次生成ID的时间，如果下次的时间比上次小，就不变更这个时间，并且用 ms 的 sequence 自增位的回调位标记，假设 sequence 有 <code>4096(12bits)</code> 可用，那么用最高位 <code>1位</code>标记回调，<code>剩余</code>每 <code>毫秒</code> <code>2048</code> 个ID可用；如果遇到 <code>反复回调</code>，还是 <code>报错</code>交上层处理把</p>
</li>
<li><p><code>Q：</code> ID混淆（避免外面很容易的猜到ID生成的规则）</p>
</li>
<li><p><code>R：</code> 常用的方式是按位转换，比如每2位和另外2位的位置做交换，最后得到的依然是一个数值类型的值；实际业务中还有这个ID过长的问题，这里采用的是把最后的ID做下转码，比如常见的转成16进制，36进制；有转码的需求在，混淆也可以混在转码过程中，比如10进制的混淆把 0-9 数字随机打乱，然后做10进制-&gt;10进制的转码就好，到其他进制同理</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - shell 打乱字符串</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span> | <span class="built_in">fold</span> -w1 | <span class="built_in">shuf</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>Q：</code> 多个区保证唯一</li>
<li><code>R：</code> 首先要给多个区编码，如果这个是登陆账号，那么需要架设一组global服务器，这个ID由global检查account没有在其他区注册过之后再生成</li>
</ul>
<h3 id="签名-token"><a href="#签名-token" class="headerlink" title="签名 token"></a>签名 token</h3><ul>
<li><code>最简单的token就是缓存在redis中的uuid了，只要有明确的重置、续期规则就好</code></li>
<li><code>对于分布式系统，不想多个系统都依赖redis的情况下，token还会做成加密后的值</code></li>
<li><code>Q：</code> 具体方式</li>
<li><code>R：</code> 核心思想是一段可解析，一段作为验证，有时间戳概念。<ul>
<li>定义一个加密Key列表，根据随机码（mn）从列表中选出一个加密Key；-&gt; secure</li>
<li>基于当前时间戳一定偏移的ts；-&gt; ts</li>
<li>ts、playerId 混淆后的 obscured -&gt; obscured</li>
<li>组合：<ul>
<li>验证部分：mn + obscured + secure 组合 md5 取部分字符</li>
<li>解析部分：mn + ts 组合的 hex 值</li>
</ul>
</li>
<li>校验：<ul>
<li>先解出2部分</li>
<li>从解析部分解析出 mn + ts</li>
<li>根据 mn 拿到 secure</li>
<li>根据 ts 和 playerId 解出 obscured</li>
<li>组合起来验证</li>
</ul>
</li>
<li>额外：<ul>
<li>这里也可以设置一个超时时间，如果这个 token 没有在本地redis中缓存，就校验 ts 是否超时了</li>
<li>因为这里认为正常逻辑里，玩家登陆后会请求覆盖到所有服务的数据</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 结构</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Signature</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> mn;           <span class="comment">// 随机码（magic number）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> ts;          <span class="comment">// 时间戳</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> obscured;    <span class="comment">// 混淆ID</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="防破解-Timing-Attack"><a href="#防破解-Timing-Attack" class="headerlink" title="防破解 - Timing Attack"></a>防破解 - Timing Attack</h3><ul>
<li>简单的解释就是hack利用密码、token等一般验证（逐个字符验证，验证到错误字符停止并返回错误）中根据验证返回的时间判断到哪个字符出错了，暴力破解的一种</li>
<li>简单的应对如下代码<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compare const, safe signature compare function (see: Timing Attack)</span></span><br><span class="line"><span class="comment">// size: std::min(a.length, b.length)</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">compare_const</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* a, <span class="type">const</span> <span class="type">void</span>* b, <span class="type">const</span> <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="literal">nullptr</span> || b == <span class="literal">nullptr</span> || size == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (a == b) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* _a = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)a;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* _b = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)b;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        result |= _a[i] ^ _b[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result == <span class="number">0</span>; <span class="comment">/* returns 0 if equal, nonzero otherwise */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="跨服务交互"><a href="#跨服务交互" class="headerlink" title="跨服务交互"></a>跨服务交互</h3><ul>
<li><code>服务器在同一局域网：</code> 基于数据访问隔离的思想一般是S1向S2要数据，通常是RPC调用</li>
<li><code>服务器不在同一局域网：</code> 可以把数据做加密后由客户端带给服务器，这里加密（签名）方式有很多，不再赘述</li>
</ul>
<h3 id="确保玩家同一时间只在一个服务器区"><a href="#确保玩家同一时间只在一个服务器区" class="headerlink" title="确保玩家同一时间只在一个服务器区"></a>确保玩家同一时间只在一个服务器区</h3><ul>
<li><code>这里假设有3个区：A, B, C</code></li>
<li><code>A, B 都只能到 C：</code> 有点像传统MMO的跨服玩法，一般的做法是 A 保存数据，标记玩家到 C 了，把数据带给 C，数据的保存还是要到 A 保存</li>
<li><code>A, B, C 可以互相跳：</code> 玩家从A到C，A检查玩家当前是在自己服务器的前提下，A先去C请求一个token，然后标记玩家此刻在C上，客户端后面用这个token去C交互</li>
</ul>
<h3 id="匹配服务"><a href="#匹配服务" class="headerlink" title="匹配服务"></a>匹配服务</h3><ul>
<li><code>避免业务层的锁：</code> redis standalone 下 lua，避免锁，lua 里面解析结构，在结构里做标记</li>
</ul>
<h3 id="避免死锁"><a href="#避免死锁" class="headerlink" title="避免死锁"></a>避免死锁</h3><ul>
<li>避免嵌套锁<br>避免发生AB, BA这种情况（这里A,B表示两个不同的互斥量(<code>std::mutex</code>)），每个线程拿到一个锁之后，别再去获取另一个锁，每个线程只持有一个锁，如果一定需要锁多个，使用下面这些对获取锁的操作上锁<ul>
<li><code>std::lock</code> (C++11 <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/thread/lock">https://en.cppreference.com/w/cpp/thread/lock</a>)</li>
<li><code>std::scoped_lock</code> (C++17 <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/thread/scoped_lock">https://en.cppreference.com/w/cpp/thread/scoped_lock</a>)</li>
</ul>
</li>
<li>避免在持有锁时调用外部代码<br>外部代码可能发生的情况是我们不确定的，在我们持有一个外部锁的情况下，外部其他代码可能也需要获取锁，如果我们和外部代码对于使用者来说都是可以独立调用的，那么就很容易产生前一种情况了</li>
<li>控制好锁的粒度，使用固定顺序获取锁<br><code>std::lock</code>&#x2F;<code>std::scoped_lock</code> 虽然可以锁多个互斥量，但是要求这些互斥量是一起作为入参的，如果出现不能使用这种方式的情况，就只好控制好锁的粒度，使用固定顺序去锁</li>
<li>对于一个可能会多次锁的对象，使用 <code>std::recursive_mutex</code></li>
</ul>
<h3 id="服务器基础性能测试"><a href="#服务器基础性能测试" class="headerlink" title="服务器基础性能测试"></a>服务器基础性能测试</h3><ul>
<li>工具：sysbench (<a target="_blank" rel="noopener" href="https://github.com/akopytov/sysbench">https://github.com/akopytov/sysbench</a>)</li>
<li>cpu 测试：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --threads=N cpu --time=300 run</span><br></pre></td></tr></table></figure>

<ul>
<li>内存测试：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --threads=N memory --time=300 run</span><br></pre></td></tr></table></figure>

<ul>
<li>网络吞吐测试：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iperf3 -c &#123;ip&#125; -p &#123;&#125; -t 100</span><br></pre></td></tr></table></figure>

<ul>
<li>IO 测试</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio -filename=/data/test -direct=1 -iodepth=1 -thread -rw=randrw -rwmixread=50 -ioengine=libaio -bs=4k -size=20G -numjobs=1 -runtime=60 -group_reporting -name=mytest</span><br></pre></td></tr></table></figure>

<ul>
<li>PS. <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/wF4M2pqlVq7KljaHAruRug">https://mp.weixin.qq.com/s/wF4M2pqlVq7KljaHAruRug</a></li>
</ul>
<blockquote>
<p>一个程序的性能构成要件大概有三个，即算法复杂度、IO开销和并发能力。<br>首要的影响因素是大家都熟悉的算法复杂度。一次核心算法优化和调整，可以对应用性能产生的影响甚至是代差级别的。<br>在实际工程实现层面，无论是犯错几率，还是留下的优化空间，反而会大为下降。甚至极端情况下，可能作为非科研主导的工程师，在进行性能优化时鲜少遇到改良算法的场景，分析问题选择合适算法会有一定占比，但是可能范围也有限。</p>
</blockquote>
<h3 id="语言艺术-通用函数简单封装"><a href="#语言艺术-通用函数简单封装" class="headerlink" title="语言艺术 - 通用函数简单封装"></a>语言艺术 - 通用函数简单封装</h3><ul>
<li>anyone &amp; container single<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// anyone</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">auto</span> anyone = [](<span class="keyword">auto</span>&amp;&amp; src, <span class="keyword">auto</span>&amp;&amp;... args) -&gt; <span class="type">bool</span> &#123; <span class="built_in">return</span> ((args == src) || ...); &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// single</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Container&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">single</span><span class="params">(Container container)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = std::<span class="built_in">cbegin</span>(container);</span><br><span class="line">    <span class="keyword">return</span> it != std::<span class="built_in">cend</span>(container) &amp;&amp; ++it == std::<span class="built_in">cend</span>(container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>自旋锁 spin lock<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">spin_lock</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::atomic_flag _flag = ATOMIC_FLAG_INIT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只是一个经验值，也可以作为lock入参</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">unsigned</span> yield_stage = <span class="number">16</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">unsigned</span> nonsleep_stage = yield_stage * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">try_lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _flag.<span class="built_in">test_and_set</span>(std::memory_order_acquire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">lock</span><span class="params">(<span class="type">unsigned</span> max_count = std::numeric_limits&lt;<span class="type">unsigned</span>&gt;::max())</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">unsigned</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (; i &lt; max_count &amp;&amp; !<span class="built_in">try_lock</span>(); ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; yield_stage)</span><br><span class="line">                std::this_thread::<span class="built_in">yield</span>();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (i &lt; nonsleep_stage)</span><br><span class="line">                std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">0</span>));</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">                std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">1000</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> i &lt; max_count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _flag.<span class="built_in">clear</span>(std::memory_order_release);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li>instanceof （还需要修改，最好能做成java那种调用的样子）<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// instanceof</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">_Src</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">__instanceof</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> base_type = _Src;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> _Ty&gt;</span></span><br><span class="line"><span class="function">    <span class="type">bool</span> <span class="title">instanceof</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> std::is_base_of&lt;_Ty, base_type&gt;::value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">_Base</span>, <span class="keyword">class</span> <span class="title class_">_Xx</span>, </span><br><span class="line">    <span class="keyword">typename</span> std::enable_if&lt;std::is_class_v&lt;_Base&gt; &amp;&amp; std::is_class_v&lt;_Xx&gt;, <span class="type">bool</span>&gt;::type = <span class="literal">true</span>&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="built_in">instanceof</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> std::is_base_of&lt;_Base, _Xx&gt;::value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">_Base</span>, <span class="keyword">class</span> <span class="title class_">_Xx</span>,</span><br><span class="line">    <span class="keyword">typename</span> std::enable_if&lt;std::is_class_v&lt;_Base&gt;&amp;&amp; std::is_class_v&lt;_Xx&gt;, <span class="type">bool</span>&gt;::type = <span class="literal">true</span>&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="built_in">instanceof</span>(_Xx xx) &#123;</span><br><span class="line">    <span class="keyword">return</span> std::is_base_of&lt;_Base, std::<span class="type">decay_t</span>&lt;<span class="keyword">decltype</span>(xx)&gt;&gt;::value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="弱网环境"><a href="#弱网环境" class="headerlink" title="弱网环境"></a>弱网环境</h3><ul>
<li>服务端网络选型上尽可能离玩家<code>更近</code>、网络质量更好的地方和网络提供商<ul>
<li>物理距离不能避免，但是也不是物理距离最近的就一定是最快的，<code>线路的带宽</code>（一定要预估好服务器需要的带宽，并且对带宽做监控，比如一旦超过50%就要准备扩了）、链路的拥塞程度、吞吐量、跨网络运营商（选<code>多线IDC</code>）很多因素影响</li>
<li>比如单独把对网络延迟要求高的服务分大区域部署多个服务节点（离玩家更近），这里需要服务端在逻辑上做好对玩家网络的判断和分配，最简单的方法在节点服务同机房开一个探测RTT的服务，客户端拿到区域内所有节点的IP，并行探测自行选择更优的节点；根据业务逻辑的需求，这个分配更可能是由玩家自主选择（类似MMO的分线、分区）、服务端基于一定指标（玩家IP所在区域、服务器存活、负载情况等）直接给玩家分配服务器；一些业务需要提前分配服务并下发Token类似的验签用于后续目标服务器对玩家身份和可进入的验签</li>
<li>可以选择 cloudflare&#x2F;cloudfront 这种 anycast 的加速服务（CDN回源），大致原理是玩家先接入边缘节点，再回源到游戏服务器，网络供应商一般会对边缘节点到服务器的网络路由做优化（最优链路，减少跳跃点），而且一般会在边缘节点卸载TLS，减少RTT</li>
</ul>
</li>
<li>修改系统里的一些<code>网络参数</code>：拥塞窗口大小、读写缓冲、time wait reuse&#x2F;recycle、retransmission timeout等等</li>
<li>使用<code>BBR的拥塞算法</code>，可以减少拥塞重传窗口折半这种情况带来的影响，网络也更平滑</li>
<li>如果不是一定要DNS的，<code>用IP</code>就好，DNS也需要消耗1RTT，DNS本身就会有劫持、老化等很多问题</li>
<li>根据业务需要看是不是可以开<code>多个链接并行</code>发送消息，甚至是2种协议，比如用udp处理帧数据，tcp&#x2F;rudp处理关键帧数据<ul>
<li>2个比较出名的rudp：KCP，QUIC</li>
<li><code>KCP:</code> 超发的处理方式，实际测试中效果并不好，弱网环境下的游戏表现也不好（之前没有做更深度的测试，最早我们游戏客户端的同步数据量很大，断网需要重新拉战场完整数据，对于这种很大的包KCP表现得延迟不如TCP好，可能和客户端当时的处理方式也有一定的关系，测试带宽也只有1M）</li>
<li><code>QUIC:</code> 已知目前IOS端在HTTP&#x2F;S上已经优先选择QUIC&#x2F;TLS1.3的方式了，quic替换长链接TCP的还没有实际应用过，需要<code>TODO</code></li>
</ul>
</li>
<li>如果也用的是TCP的长链接方式，对于手机端一定要自己定义<code>异步的keepalive</code>消息，<code>避免切后台导致链接断开</code>（unity update在切后台会停止）；需要重连的时候，避免一个循环没有时间等待的反复重连重试，避免重连带给服务端瞬间的accept（半链接队列）压力</li>
<li>对于客户端的网络实现，优先分别给Android&#x2F;IOS单独写，用<code>系统上最优的socket</code>，比如unity的webHttpSocket的封装，服务端支持的情况下，IOS端会优先用QUIC+TLS1.3的方式</li>
<li>短连接需要避免每次都要握手的情况（http keepalive、QUIC），长链接需要异步keepalive</li>
<li>打开<code>TCP_NODELAY</code>选项，这个基本是游戏里的默认选项了</li>
<li>尽量控制传输<code>数据包大小在一个MSS内</code>，<code>避免分片</code>，任何一个分片的出现丢失都可能会造成多次传输、确认（还有分片、拼接的开销）；建议不要超过1400&#x2F;1360字节，虽然MTU&#x3D;1500情况下，TCP的MSS&#x3D;1500 - 20(IP) - 20(TCP) &#x3D; 1460，但是很多服务器、网络设备的MTU设置是小于1500的</li>
<li>协议编码上尽量用占字节少的<code>二进制编码方式</code>（protobuffer），减小包体大小，有必要的话做<code>压缩</code>，用CPU时间换网络时间</li>
<li>同步类型的消息尽量计<code>算差异后再组包发送</code>，而不是把所有都序列化到包里，数据对表现的驱动方式最好是状态类型的驱动，比如一个跑步的驱动，如果用状态可能只需要1-5个字节（标记枚举），但是要从动画驱动的话，一次跑动胳膊腿甚至手持的装备都是动画差异，包体也就更大了（游戏里我看到是先迈的左脚和你看到先迈右脚其实没有区别吧），这里也是要跟业务走，可以混合状态、动画驱动</li>
<li><code>减少双端同步量&amp;处理量</code>，避免无谓的消息处理和带宽占用。场景同步的游戏中，可以考虑在玩家处于某些状态的时候不要同步那么多事件到客户端；例如在九宫格地图（玩家一屏的可见视野是9个格子）中我正在打怪，而我攻击的最大范围只有一个格子，这时候服务端同步的主要内容应该集中在这一个格子里对象的事件，对于周边的其他格子信息，可以换成更小的数据包（减少客户端解析数据&amp;处理数据的时间消耗），或者由客户端以lazy帧的频率主动向服务端请求变化信息（当然这样相比服务端主动推送多了1次RTT）</li>
<li><code>关于让客户端主动请求的题外话：</code>服务器端一般情况下对于每个客户端相同行为处理的消耗时间是相同的，也就是服务端会以相同的频率向客户端广播消息（排除一些时间服务端由于性能问题处理的差异），而客户端是玩家的设备，也就是不同设备支持的最高帧率、不同网络环境的延迟都是不一样的；客户端的处理事件需要一个个处理，可能A设备1档机处理一个事件1s（比较用的单位时间），B设备3档机需要3s，服务端以相同的频率给到2个客户端的消息，他们实际处理的效率是不一样的，无端的浪费了带宽；所以是不是或者至少在某些状态下，由客户端主动发起请求，服务端再回执而不是主动push到客户端表现会更好。</li>
<li><code>在gateway做广播目标对象的筛选：</code>这里认为传统服务器单个场景是在一个gameservice的，但是单个场景的玩家是在多个gateway的，一次事件gs只需要把事件本身（也就是消息同步的message-body）广播到gateway上，由gateway做需要广播玩家的筛选，因为gateway是多组并且可以水平扩展，这样子做可以减轻gs遍历玩家的成本，也减轻gs到gateway的带宽压力（即使常规认为内网通讯是1Gbps的带宽，跑了网络传输，大包和小包影响还是很大的）；这样子做就需要gateway上有一部分场景的信息，比如九宫格放到gateway上，用二维（三维）数组方式空间换时间，拿到需要广播的对象，把消息广播出去</li>
<li><code>客户端超发：</code>前面提到了多个链接（甚至多种协议并行），但是这里需要做不同链接协议处理的解耦、合并等策略，需要看游戏是怎么拆分协议的，也需要看是不是有些协议上的丢弃在其他协议补偿之后可以足够满足游戏表现和数据上需要的内容；在这个基础上，如果用的是udp或者http的协议，如果用多通道超发的方式，也许能提高一些网络性能，但是会牺牲掉流量成本也会提高服务端的带宽压力；（由于拥塞控制的关系，tcp在这里是不合适的。）</li>
<li>…….</li>
<li>还有很多没想到或者实际遇到处理的问题</li>
</ul>
<h3 id="防作弊"><a href="#防作弊" class="headerlink" title="防作弊"></a>防作弊</h3><p>从安全性上来说，<code>客户端计算</code> 模型 远远弱于 <code>服务端校验</code>，而 <code>服务端校验</code> 又弱于 <code>服务端计算</code><br>作弊的技术手法，有这些大类</p>
<ul>
<li>按键精灵类；</li>
<li>加速(变速齿轮类)；</li>
<li>改内存数值(比如改合作回合数、改SP、锁血等)；</li>
<li>破解游戏包(比如直接改骰子配置参数)；</li>
<li>修改网络包，包括：拦截包、修改包、重放包等等；</li>
<li>脱机外挂类；</li>
<li>其他；<br>以上作弊手法，对作弊者的技术要求大体是逐渐升高的。目前出现的尚集中于前4种。外挂攻防是一个螺旋上升的过程</li>
</ul>
<p>通常，作为典型加速器的速度档会改变过程时间。这意味着游戏客户端的内部时间比服务器快。我们可以检测服务器和客户端之间的时间，以判断玩家是否通过加速器作弊。这就是重点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        t0                                            t3</span><br><span class="line">Server  |---------------------------------------------|</span><br><span class="line">         &gt;&gt;&gt;&gt;                                     &gt;&gt;&gt;&gt;</span><br><span class="line">Client        |-----------------------------------|</span><br><span class="line">             t1                                  t2</span><br></pre></td></tr></table></figure>
<ul>
<li>t0：服务器向客户端发送初始化包（如游戏开始事件）。当前服务器时间为t0；</li>
<li>t1：客户端在从服务器接收到init数据包后的每个间隔（例如1秒）后发送一个心跳数据包。t1是指发送第一心跳包的客户端时间，也是客户端游戏的开始时间；</li>
<li>t2: 表示从客户端发送的最后一个心跳包的客户端时间；</li>
<li>t3: 是服务器完成游戏或服务器随时检测到作弊的服务器时间；</li>
</ul>
<p>显然，我们可以安全地说（t3-t0）&gt;&#x3D;（t2-t1）。实际上（t3-t0）≈ ((t2-t1）+ TTL*1）。<br>服务器如何知道（t2-t1）？作为替代，我们可以使用<code>((heartheat_count+1）* interval）</code>作为（t2-t1）。<br>为了更安全，我们可以检查<code>（t3-t0）*（1+冗余）&gt;= ((heartheat_count+1）* 间隔）</code>。例如，间隔可以是1秒，冗余可以是<code>0.02</code>。<br>首先，该解决方案无法检测到所有欺诈行为，如假客户端。但这应该足以赶上速度档。<br>第二，这个解决方案被用于一些在线游戏（包括MMORPG、赛车游戏、塔防游戏等），在我的职业生涯中，这些游戏的PCCU（最高在线人数）远远超过了100K。</p>
<p>即使正常玩家在游戏期间更改了操作系统时间，也很少会对他们造成伤害，因为我们使用心跳计数而不是客户端时间。我确实发现有些电脑的时钟芯片比平时快得多。但冗余保护了这种情况。因此，解决方案非常安全。</p>
<p>在服务端是2块的校验，包数量和时间；比如检测加速（<code>10s或者300个移动包</code>）检测一次距离</p>
<h3 id="防破解"><a href="#防破解" class="headerlink" title="防破解"></a>防破解</h3><blockquote>
<p>协议非对称加密交换秘钥，对称加密传输内容，保护好服务端私钥，防止中间人攻击。流式加密，同样包发2次内容不一样<br>不用标准序列化工具如protocolbuf，用修改版或者自己实现的<br>客户端加密加壳防止调试和注入，程序签名防止篡改二进制<br>重要的代码放虚拟机或者脚本里运行（脚本字节码需要改），一般黑客主要分析反汇编，你复杂逻辑多套基层他就晕了<br>关键数据不落内存，一律使用getxx，setxx之类的接口，后面将真实数据经过变换以后才落内存<br>守护进程动态跟踪监控情况<br>决定性逻辑永远放在服务端<br>服务端定期校验消息合理性，比如 10s 内最大的移动步长是多少，实际发上来的合理不合理，不合理就踢掉，比如按键点击频率是否超过正常人<br>不定期弹出反外挂答题，答正确奖励经验，错误就掉线<br>必须要放在客户端计算的内容将输入和结果hash同步给其他客户端验算，不对就踢掉<br>当检测到客户端触碰到某规则不要急着踢掉它，而是有概率的被踢掉，还要随机几秒踢掉，这样黑客发现一会这里断一会那里断，就蒙圈了<br>发现某黑客&#x2F;外挂工具利用某漏洞破解了游戏，先看影响大不大，再看他挣不挣钱，影响一般又不挣钱的话可以先养着他，等他挣钱了用户多了，大型活动之前，一条指令就把它封了，用户退款都可以弄得他爬不起来</p>
</blockquote>

    </div>
    
    
    
    <div>
      
      <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">------ 本文结束 ------</div>
        <div style="text-align:center;color: #ccc;font-size:14px;">------ 版权声明：转载请注明出处 ------</div>
    
</div>
      
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%A4%87%E5%BF%98/" rel="tag"># 备忘</a>
          </div>

        
  <div class="post-widgets">
    <div class="wp_rating">
      <div id="wpac-rating"></div>
    </div>
  </div>


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/archives/40317e6a.html" rel="prev" title="性能：linux Performance Analysis in 60,000 Milliseconds">
      <i class="fa fa-chevron-left"></i> 性能：linux Performance Analysis in 60,000 Milliseconds
    </a></div>
      <div class="post-nav-item">
    <a href="/archives/ce87bb9c.html" rel="next" title="ZGC">
      ZGC <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JAVA%EF%BC%8CC"><span class="nav-number">2.</span> <span class="nav-text">JAVA，C++</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CDN-%E5%BC%BA%E5%88%B6%E5%9B%9E%E6%BA%90"><span class="nav-number">3.</span> <span class="nav-text">CDN 强制回源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tc-%E5%91%BD%E4%BB%A4"><span class="nav-number">4.</span> <span class="nav-text">tc 命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90"><span class="nav-number">5.</span> <span class="nav-text">日志解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%BA%E7%9C%81%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E5%90%84%E5%8D%8F%E8%AE%AE%E7%9A%84%E8%80%81%E5%8C%96%E6%97%B6%E9%97%B4%E4%B8%BA%EF%BC%9A"><span class="nav-number">6.</span> <span class="nav-text">缺省情况下，各协议的老化时间为：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BBR-CUBIC-%E7%AE%97%E6%B3%95%E6%B5%8B%E8%AF%95"><span class="nav-number">7.</span> <span class="nav-text">BBR&#x2F;CUBIC 算法测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%94%AF%E4%B8%80ID"><span class="nav-number">8.</span> <span class="nav-text">唯一ID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%BE%E5%90%8D-token"><span class="nav-number">9.</span> <span class="nav-text">签名 token</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B2%E7%A0%B4%E8%A7%A3-Timing-Attack"><span class="nav-number">10.</span> <span class="nav-text">防破解 - Timing Attack</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%A8%E6%9C%8D%E5%8A%A1%E4%BA%A4%E4%BA%92"><span class="nav-number">11.</span> <span class="nav-text">跨服务交互</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AE%E4%BF%9D%E7%8E%A9%E5%AE%B6%E5%90%8C%E4%B8%80%E6%97%B6%E9%97%B4%E5%8F%AA%E5%9C%A8%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8C%BA"><span class="nav-number">12.</span> <span class="nav-text">确保玩家同一时间只在一个服务器区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%B9%E9%85%8D%E6%9C%8D%E5%8A%A1"><span class="nav-number">13.</span> <span class="nav-text">匹配服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81"><span class="nav-number">14.</span> <span class="nav-text">避免死锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9F%BA%E7%A1%80%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="nav-number">15.</span> <span class="nav-text">服务器基础性能测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AD%E8%A8%80%E8%89%BA%E6%9C%AF-%E9%80%9A%E7%94%A8%E5%87%BD%E6%95%B0%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85"><span class="nav-number">16.</span> <span class="nav-text">语言艺术 - 通用函数简单封装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%B1%E7%BD%91%E7%8E%AF%E5%A2%83"><span class="nav-number">17.</span> <span class="nav-text">弱网环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B2%E4%BD%9C%E5%BC%8A"><span class="nav-number">18.</span> <span class="nav-text">防作弊</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B2%E7%A0%B4%E8%A7%A3"><span class="nav-number">19.</span> <span class="nav-text">防破解</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Kinly"
      src="/uploads/kinly-avatar.png">
  <p class="site-author-name" itemprop="name">Kinly</p>
  <div class="site-description" itemprop="description">Klysisle's 小窝</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      friendly
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://gqw.github.io/" title="https:&#x2F;&#x2F;gqw.github.io&#x2F;" rel="noopener" target="_blank">顾起威's blog</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kinly</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>



  <script>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id    : ,
      el    : 'wpac-rating',
      color : 'fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>












  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '6741134bc57bd79787a9',
      clientSecret: 'ce6491d7fecebe5bf246e104cbae0f3412cc9c92',
      repo        : 'kinly.github.io',
      owner       : 'kinly',
      admin       : ['kinly'],
      id          : '55e55ccae8acb83cf48fe445698ae825',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
